<!DOCTYPE html>
<html dir="rtl" lang="he">

<head>
    <title>סיכויי זכייה - דירה בהנחה</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🏡</text></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css">
    <!-- <style>
        @import url('https://fonts.googleapis.com/css2?family=Varela+Round&display=swap');
    </style>
    <style>
        body {
            /* font-family: Arial, sans-serif; */
            font-family: "Varela Round", sans-serif;
            text-align: right;
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
            background: #fff;
            color: #222;
        }

        .autoMargin {
            margin: 0 auto;
            width: fit-content;
        }

        li {
            margin-bottom: 4px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            /* border: 1px solid #222; */
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        th:focus,
        td:focus,
        input:focus,
        button:focus,
        select:focus {
            outline: 2px solid #005fcc;
            outline-offset: 2px;
        }

        .project-row td div[title="מחושב - אחרי הורדת זוכים קודמים"] {
            font-size: 0.9em;
            font-weight: normal;
            color: #555;
        }

        th:nth-child(3),
        .project-row td:nth-child(3),
        .chance-row td:nth-child(1) {
            border-left: 3px solid #ddd;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #e6f7ff;
        }

        .checkbox-container {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-container label {
            margin-left: 15px;
        }

        .input-container-grid {
            display: grid;
            grid-template-columns: max-content auto;
            gap: 10px;
            align-items: center;
        }

        .input-container-grid label {
            grid-column: 1;
        }

        .input-container-grid input {
            grid-column: 2;
            width: 50px;
        }

        .input-container {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .input-container input[type="search"],
        .input-container input[type="number"] {
            padding: 5px;
            margin-left: 10px;
        }

        .input-container button {
            padding: 5px 10px;
            cursor: pointer;
        }

        .chance-row {
            background-color: #e0f7fa;
            font-weight: bold;
        }

        .total-row {
            background-color: #eeddc2 !important;
            font-weight: bold;
        }

        .bold {
            font-weight: bold;
        }

        .loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            z-index: 9999;
            background: rgba(0, 0, 0, 0.137);
            display: block;
            perspective: 1000px;
            border-radius: 50%;
            width: 348px;
            height: 348px;
            color: #7a96e4;
        }

        .loader:before,
        .loader:after {
            content: '';
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: inherit;
            height: inherit;
            border-radius: 50%;
            transform: rotateX(70deg);
            animation: 1.2s spin linear infinite;
        }

        .loader:after {
            color: #FF3D00;
            transform: rotateY(70deg);
            animation-delay: .4s;
        }

        @keyframes spin {

            0%,
            100% {
                box-shadow: .6em 0px 0 0px currentcolor;
            }

            12% {
                box-shadow: .6em .6em 0 0 currentcolor;
            }

            25% {
                box-shadow: 0 .6em 0 0px currentcolor;
            }

            37% {
                box-shadow: -.8em .8em 0 0 currentcolor;
            }

            50% {
                box-shadow: -.2em 0 0 0 currentcolor;
            }

            62% {
                box-shadow: -.2em -.2em 0 0 currentcolor;
            }

            75% {
                box-shadow: 0px -.2em 0 0 currentcolor;
            }

            87% {
                box-shadow: .2em -.2em 0 0 currentcolor;
            }
        }

        @media screen and (max-width: 1024px) {
            table {
                font-size: 14px;
            }

            th,
            td {
                padding: 6px 4px;
            }
        }

        @media screen and (max-width: 768px) {
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -15px;
                padding: 0 15px;
            }

            table {
                min-width: 800px;
            }
        }

        @media screen and (max-width: 480px) {
            body {
                padding: 10px;
                font-size: 14px;
            }

            h1 {
                font-size: 1.5em;
                margin-bottom: 15px;
            }

            h3 {
                font-size: 1.2em;
                margin-bottom: 10px;
            }

            input,
            button {
                font-size: 16px;
            }
        }

        h3 {
            margin-top: 30px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        /* Visually hidden class for accessibility */
        .visually-hidden {
            position: absolute !important;
            height: 1px;
            width: 1px;
            overflow: hidden;
            clip: rect(1px, 1px, 1px, 1px);
            white-space: nowrap;
        }

        fieldset {
            padding: 0;
            border: 0;
        }

        #results-caption {
            /* font-size: 1.5em; */
            font-weight: bold;
            padding: 0.7em;
            text-align: right;

        }

        .main-flex {
            display: flex;
            flex-direction: row-reverse;
            align-items: flex-start;
            gap: 30px;
        }

        .form-container {
            flex: 1 1 0;
            min-width: 250px;
        }

        .form-group {
            display: inline-block
        }

        @media screen and (max-width: 900px) {
            .main-flex {
                gap: 15px;
            }
        }

        @media screen and (max-width: 600px) {
            .main-flex {
                flex-direction: column-reverse;
                align-items: stretch;
            }


        }

        .bottom-image {
            width: 100%;
            /* text-align: center; */
            margin-top: 20px;
        }

        .bottom-image #frame {
            /* max-height: 100px; */
            max-width: 400px;
            width: auto;
            height: auto;
            background: #fff !important;
        }

        .note {
            color: rgb(99, 99, 99);
            font-weight: normal;
            margin-bottom: 10px;
        }

        .none {
            display: none;
        }

        #results-caption:hover {
            text-decoration: underline;
        }

        #results-caption {
            cursor: pointer;
        }
        .flex-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        } -->
    </style>
</head>

<body>
    <div class="autoMargin">
        <span id="loader" class="" aria-live="polite" aria-busy="false"></span>
        <h1>בדיקת סיכויי זכייה - דירה בהנחה</h1>
        <div class="note">מחשבון זה נעשה לשימוש עצמי ואין אחריות על שימוש והתוצאות</div>

        <div class="main-flex">

            <div class="form-container">
                <form aria-labelledby="form-title">
                    <fieldset>
                        <legend id="form-title" class="visually-hidden">הגדרות חישוב</legend>
                        <h3 id="status-title">בחר את המעמד שלך</h3>
                        <div class="checkbox-container" role="group" aria-labelledby="status-title">
                            <label for="handicappedSubscriber"><input type="checkbox" id="handicappedSubscriber"
                                    value="HandicappedSubscriber"> בעל מוגבלות</label>
                            <label for="combatReservistSubscriber"><input type="checkbox" id="combatReservistSubscriber"
                                    value="CombatReservistSubscriber"> מילואים קרבי</label>
                            <label for="reservedDutySubscriber"><input type="checkbox" id="reservedDutySubscriber"
                                    value="ReservedDutySubscriber"> מילואים</label>
                            <label style="flex-basis: 100%;" for="localSubscriber"> בן העיר:
                                <input type="search" id="localSubscriber" list="cityList" value="" aria-label="בחר עיר"
                                    style="width:130px">
                                <!-- <input type="checkbox" id="localSubscriber" value="LocalSubscriber"> -->
                            </label>
                        </div>

                        <h3 id="percent-title">הערכות</h3>
                        <div class="note">כל עוד אין מידע
                            רשמי
                            המחשבון
                            ישתמש בהערכה זו</div>
                        <div class="input-container-grid" role="group" aria-labelledby="percent-title">
                            <label for="combatPercent">אחוז משרתי מילואים קרביים: </label>
                            <input type="number" id="combatPercent" min="0" max="100" step="1" value="10"
                                aria-label="אחוז משרתי מילואים קרביים">
                            <label for="reservedPercent">אחוז משרתי מילואים: </label>
                            <input type="number" id="reservedPercent" min="0" max="100" step="1" value="10"
                                aria-label="אחוז משרתי מילואים">

                            <label for="recurringSubscribersPercent">אחוז הרשומים בכל הפרוייקטים:
                            </label>
                            <input type="number" id="recurringSubscribersPercent" min="0" max="100" step="1" value="90"
                                aria-label="אחוז הרשומים בכל הפרוייקטים">

                        </div>

                        <h3 id="city-title">חיפוש לפי עיר</h3>
                        <div class="note">בחירה או הסרה (ctrl + קליק)</div>
                        <div class="input-container" role="group" aria-labelledby="city-title">
                            <!-- <label for="cityInput">בחר עד 3 ערים: </label> -->
                            <select id="cityInput" multiple size="5" aria-label="בחר ערים">
                                <option value="אכסאל">אכסאל</option>
                                <option value="אשקלון">אשקלון</option>
                                <option value="באר יעקב">באר יעקב</option>
                                <option value="באר שבע">באר שבע</option>
                                <option value="בית שמש">בית שמש</option>
                                <option value="דימונה">דימונה</option>
                                <option value="טבריה">טבריה</option>
                                <option value="יבנה">יבנה</option>
                                <option value="יהוד">יהוד</option>
                                <option value="ירושלים">ירושלים</option>
                                <option value="כפר ורדים">כפר ורדים</option>
                                <option value="מעלות-תרשיחא">מעלות-תרשיחא</option>
                                <option value="מצפה רמון">מצפה רמון</option>
                                <option value="נוף הגליל">נוף הגליל</option>
                                <option value="נתניה">נתניה</option>
                                <option value="עכו">עכו</option>
                                <option value="עפולה">עפולה</option>
                                <option value="קריית ביאליק">קריית ביאליק</option>
                                <option value="קריית גת">קריית גת</option>
                                <option value="קריית עקרון">קריית עקרון</option>
                                <option value="רעננה">רעננה</option>
                            </select>
                            <!-- <label for="cityInput">עיר: </label>
                            <input type="search" id="cityInput" list="cityList" value="" aria-label="בחר עיר"> -->
                            <div class="flex-column">
                                <a href="javascript:void(0)" onclick="selectAllCities()">בחר את כל הערים</a>
                                <button type="button" onclick="fetchAndDisplayProjects()"
                                    aria-label="חשב תוצאות">חשב</button>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
        <div id="results" class="table-wrapper" aria-live="polite"></div>

        <div class="bottom-image">
            <div class="autoMargin">ניסוי פרסומת, לא יודע מה יצא פה</div>
            <!-- <img src="https://picsum.photos/400/100" alt="אולי בהמשך פרסומת" /> -->
            <div id="frame"
                style="width: 100%;margin: auto;background: rgba(0, 0, 0, 0.50);position: relative; z-index: 99998;">
                <iframe data-aa='2408072' src='//acceptable.a-ads.com/2408072/?size=Adaptive'
                    style='border:0; padding:0; width:70%; height:auto; overflow:hidden;display: block;margin: auto'></iframe>
            </div>
            <div>
                <h3>הערות</h3>
                <ul>
                    <li>בסימון מספר מעמדות, יחשב הסיכוי לזכות בכל אחת מהן ובהגרלה הכללית של הפרוייקט</li>
                    <li>לוחמים יוגרלו שוב במעמד מילואים תוך חיסור מי שזכה</li>
                    <li>בהגרלה הכללית של הפרוייקט יוחסרו מספר הזוכים והדירות מההגרלות לפי מעמד</li>
                    <li>'אחוז הרשומים בכל הפרוייקטים' ירד מפרוייקט לפרוייקט, כך שאם הגדרנו ש-90% נמצאים בכל ההגרלות, אז
                        בין הפרוייקטים ניתן להוריד ממספר הנרשמים 90% ממספר הזוכים מהפרוייקטים הקודמים, וסיכויי הזכייה
                        עולים</li>
                    <li>כאשר יש מספר ומתחתיו מספר בסוגריים, המספר העליון הוא מידע הבסיס, והתחתון מחושב בפועל לאחר הורדת
                        הזוכים הקודמים</li>
                    <li>אני לא פרופסור לסטטיסטיקה יתכנו טעויות :-)</li>
                </ul>
            </div>
            <!-- <div>
                <h3>הצהרת נגישות</h3>
                <div>ניסיתי שהכל יעמוד בכללי הנגישות אך בגלל שהעמוד לשימוש שלי ולעמוד מעט מאוד משתמשים אין צורך חוקי
                    לעשות זאת</div>
            </div> -->
        </div>
    </div>
    <script>
        // Restore user inputs from localstorage
        const selectedCities = JSON.parse(localStorage.getItem('selectedCities')) || [];
        const cityInput = document.getElementById('cityInput');
        for (const option of cityInput.options) {
            option.selected = selectedCities.includes(option.value);
        }
        document.getElementById('localSubscriber').value = localStorage.getItem('localCity') || '';
        document.getElementById('handicappedSubscriber').checked = localStorage.getItem('isHandicapped') === 'true';
        document.getElementById('reservedDutySubscriber').checked = localStorage.getItem('isReserved') === 'true';
        document.getElementById('combatReservistSubscriber').checked = localStorage.getItem('isCombat') === 'true';
        document.getElementById('combatPercent').value = (parseFloat(localStorage.getItem('combatPercent')) * 100) || 10;
        document.getElementById('reservedPercent').value = (parseFloat(localStorage.getItem('reservedPercent')) * 100) || 10;
        document.getElementById('recurringSubscribersPercent').value = (parseFloat(localStorage.getItem('recurringPercent')) * 100) || 90;

        let data = {};
        let currentDate;

        async function fetchAndDisplayProjects() {
            const loader = document.getElementById('loader');
            loader.classList.add('loader');
            loader.setAttribute('aria-busy', 'true');

            const selectedCities = Array.from(document.getElementById('cityInput').selectedOptions).map(option => option.value);
            const localCity = document.getElementById('localSubscriber').value.trim();
            const isHandicapped = document.getElementById('handicappedSubscriber').checked;
            const isReserved = document.getElementById('reservedDutySubscriber').checked;
            const isCombat = document.getElementById('combatReservistSubscriber').checked;

            const combatPercent = parseFloat(document.getElementById('combatPercent').value) / 100 || 0;
            const reservedPercent = parseFloat(document.getElementById('reservedPercent').value) / 100 || 0;
            const recurringPercent = parseFloat(document.getElementById('recurringSubscribersPercent').value) / 100 || 0;

            // Save all user inputs to localstorage so we can use it again later
            localStorage.setItem('selectedCities', JSON.stringify(selectedCities));
            localStorage.setItem('localCity', localCity);
            localStorage.setItem('isHandicapped', isHandicapped);
            localStorage.setItem('isReserved', isReserved);
            localStorage.setItem('isCombat', isCombat);
            localStorage.setItem('combatPercent', combatPercent);
            localStorage.setItem('reservedPercent', reservedPercent);
            localStorage.setItem('recurringPercent', recurringPercent);

            // Helpers
            function fmtInt(n) {
                return (typeof n === 'number' && isFinite(n)) ? Math.round(n).toLocaleString('he-IL') : '-';
            }
            function renderCell(originalNum, calculatedNum) {
                const title = "מחושב - אחרי הורדת זוכים קודמים";
                const origStr = fmtInt(originalNum);
                const calcStr = fmtInt(calculatedNum);
                if (calcStr === '-' || origStr === calcStr) return origStr;
                return `${origStr}<div title="${title}">(${calcStr})</div>`;
            }
            function showPctOrDash(v) {
                return (!isNaN(v) && isFinite(v)) ? (v * 100).toFixed(2) + '%' : '-';
            }
            function isLocal(project) {
                return project && project.CityDescription === localCity;
            }

            try {
                if (Object.keys(data).length === 0) {
                    const queryString = "?firstApplicantIdentityNumber=&secondApplicantIdentityNumber=&ProjectStatus=4&Entitlement=1&PageNumber=1&PageSize=75&IsInit=true&";
                    const encodedString = encodeURIComponent(queryString);
                    const response = await fetch("https://www.dira.moch.gov.il/api/Invoker?method=Projects&param=" + encodedString, {
                        "headers": {
                            "User-Agent": "Mozilla/5.0",
                            "Accept": "application/json, text/plain, */*",
                            "Accept-Language": "he-IL,he;q=0.8,en-US;q=0.5,en;q=0.3",
                            "Sec-GPC": "1",
                            "Sec-Fetch-Dest": "empty",
                            "Sec-Fetch-Mode": "cors",
                            "Pragma": "no-cache",
                            "Cache-Control": "no-cache"
                        },
                        "referrer": "https://www.dira.moch.gov.il/ProjectsList",
                        "method": "GET",
                        "mode": "cors"
                    });

                    data = await response.json();
                    currentDate = new Date();
                } else {
                    // Small delay to visualize update
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                // Decide which cities to process:
                const allCityNames = Array.from(new Set((data.ProjectItems || []).map(p => p.CityDescription))).filter(Boolean);
                const citiesToProcess = (selectedCities && selectedCities.length > 0) ? selectedCities : allCityNames;

                // For each city, build its table and keep its total chance for later ranking
                const perCityResults = [];

                for (const cityDescription of citiesToProcess) {
                    let projects = (data.ProjectItems || []).filter(item => item.CityDescription === cityDescription);

                    projects.sort((a, b) => {
                        const na = Number(a.LotteryNumber);
                        const nb = Number(b.LotteryNumber);
                        if (!isNaN(na) && !isNaN(nb)) return na - nb;
                        return String(a.LotteryNumber || '').localeCompare(String(b.LotteryNumber || ''));
                    });

                    const overallChances = [];
                    let tableHtml = '';

                    if (projects.length > 0) {
                        const cumulativeWinners = {
                            handicapped: 0,
                            combat: 0,
                            reservist: 0,
                            local: 0,
                            general: 0,
                            total: 0
                        };

                        // infer handicapped/local % from the first project (safely)
                        const first = projects[0];
                        const firstTotalSubscribers = Number(first.TotalSubscribers) || 0;
                        const inferredHandicappedPercent = firstTotalSubscribers > 0 ? (Number(first.TotalHandicappedSubscribers) || 0) / firstTotalSubscribers : 0;
                        const inferredLocalPercent = firstTotalSubscribers > 0 ? (Number(first.TotalLocalSubscribers) || 0) / firstTotalSubscribers : 0;

                        tableHtml += `
                <table aria-describedby="results-caption" role="button" aria-expanded="false" aria-controls="lotteryTableContent" onclick="toggleTableRows(this)">
                    <caption id="results-caption">טבלת סיכויי זכייה - ${cityDescription} ▾</caption>
                    <thead>
                    <tr>
                        <th scope="col">הגרלה</th>
                        <th scope="col">עיר</th>
                        <th scope="col">מחיר למ"ר</th>
                        <th scope="col">נרשמים עם מוגבלות</th>
                        <th scope="col">דירות לבעלי מוגבלות</th>
                        <th scope="col">נרשמים מילואים קרביים</th>
                        <th scope="col">דירות למילואים קרביים</th>
                        <th scope="col">נרשמים מילואים</th>
                        <th scope="col">דירות למילואים</th>
                        <th scope="col">נרשמים בני העיר</th>
                        <th scope="col">דירות בני העיר</th>
                        <th scope="col">סה"כ נרשמים</th>
                        <th scope="col">דירות</th>
                        <th scope="col">סיכוי זכייה כולל</th>
                    </tr>
                    </thead>
                    <tbody>
                `;

                        projects.forEach((project) => {
                            // ----- TOTAL subscribers: original (raw) -----
                            const raw_total_subs = Number(project.TotalSubscribers) || 0;

                            // Adjusted total used upstream for category estimates (recurring winners only).
                            const totalSubscribers = Math.max(0, Math.floor(raw_total_subs - recurringPercent * cumulativeWinners.total));

                            // ----- Handicapped -----
                            const apiHand = Number(project.TotalHandicappedSubscribers);
                            const orig_h = (Number.isFinite(apiHand) && apiHand > 0)
                                ? Math.floor(apiHand)
                                : Math.floor(raw_total_subs * inferredHandicappedPercent);
                            let subs_h = Math.max(0, Math.floor(orig_h - recurringPercent * cumulativeWinners.handicapped));

                            // ----- Combat -----
                            const apiCombat = Number(project.TotalCombatReservistSubscribers);
                            const orig_c = (Number.isFinite(apiCombat) && apiCombat > 0)
                                ? Math.floor(apiCombat)
                                : Math.floor(combatPercent > 0 ? raw_total_subs * combatPercent : 0);
                            let subs_c = Math.max(0, Math.floor(orig_c - recurringPercent * cumulativeWinners.combat));

                            // ----- Reservists -----
                            const apiReserved = Number(project.TotalReservedDutySubscribers);
                            const orig_r = (Number.isFinite(apiReserved) && apiReserved > 0)
                                ? Math.floor(apiReserved)
                                : Math.floor(reservedPercent > 0 ? raw_total_subs * reservedPercent : 0);
                            let subs_r = Math.max(0, Math.floor(orig_r - recurringPercent * cumulativeWinners.reservist));

                            // ----- Local -----
                            const apiLocal = Number(project.TotalLocalSubscribers);
                            const orig_l = (Number.isFinite(apiLocal) && apiLocal > 0)
                                ? Math.floor(apiLocal)
                                : Math.floor(raw_total_subs * inferredLocalPercent);
                            let subs_l = Math.max(0, Math.floor(orig_l - recurringPercent * cumulativeWinners.local));

                            // Units per category
                            const units_h = Number(project.HousingUnitsForHandicapped) || 0;
                            const units_c = Number(project.HU_CombatReservist_L) || 0;
                            const units_r = Number(project.HU_Reservists_L) || 0;
                            const units_l = Number(project.LocalHousing) || 0;
                            const total_units = Number(project.LotteryApparmentsNum) || 0;

                            // Price field
                            const price_per_unit = (project.PricePerUnit ?? '');

                            // Chances
                            const chance_h = isHandicapped && subs_h > 0 ? Math.min(1, units_h / subs_h) : 0;

                            // Winners per category and spillover (combat -> reservist)
                            const winners_h = Math.min(units_h, subs_h);

                            const winners_c = Math.min(units_c, subs_c);
                            const remaining_combat = Math.max(0, subs_c - winners_c);

                            const effective_subs_r = Math.max(0, subs_r + remaining_combat);
                            const chance_c = isCombat && subs_c > 0 ? Math.min(1, units_c / subs_c) : 0;
                            const chance_r = (isReserved || isCombat) && effective_subs_r > 0 ? Math.min(1, units_r / effective_subs_r) : 0;

                            const winners_r = Math.min(units_r, effective_subs_r);

                            const chance_l = isLocal(project) && subs_l > 0 ? Math.min(1, units_l / subs_l) : 0;
                            const winners_l = Math.min(units_l, subs_l);

                            // General lottery
                            let remaining_units = Math.max(0, total_units - (winners_h + winners_c + winners_r + winners_l));
                            let remaining_subs = Math.max(0, totalSubscribers - (winners_h + winners_c + winners_r + winners_l));
                            const chance_g = remaining_subs > 0 ? Math.min(1, remaining_units / remaining_subs) : 0;

                            // Overall chance (sequential)
                            let overall_chance = 0;
                            let prob_not_won = 1;
                            function safeAddChance(ch) {
                                if (!isNaN(ch) && isFinite(ch) && ch > 0) {
                                    overall_chance += prob_not_won * ch;
                                    prob_not_won *= (1 - ch);
                                }
                            }
                            safeAddChance(chance_h);
                            safeAddChance(chance_c);
                            safeAddChance(chance_r);
                            safeAddChance(chance_l);
                            safeAddChance(chance_g);

                            const overall_chance_percent = (!isNaN(overall_chance) && isFinite(overall_chance)) ? (overall_chance * 100).toFixed(2) + '%' : '-';
                            overallChances.push(!isNaN(overall_chance) && isFinite(overall_chance) ? Math.max(0, Math.min(1, overall_chance)) : 0);

                            // Update cumulative winners
                            const general_winners = Math.min(remaining_units, remaining_subs);
                            cumulativeWinners.handicapped += winners_h;
                            cumulativeWinners.combat += winners_c;
                            cumulativeWinners.reservist += winners_r;
                            cumulativeWinners.local += winners_l;
                            cumulativeWinners.general += general_winners;
                            cumulativeWinners.total =
                                cumulativeWinners.handicapped +
                                cumulativeWinners.combat +
                                cumulativeWinners.reservist +
                                cumulativeWinners.local +
                                cumulativeWinners.general;

                            // Rows
                            tableHtml += `
                        <tr class="project-row">
                            <td>${project.LotteryNumber || ''}</td>
                            <td>${project.CityDescription || ''}</td>
                            <td>${price_per_unit}</td>

                            <td >${renderCell(orig_h, subs_h)}</td>
                            <td>${fmtInt(units_h)}</td>

                            <td >${renderCell(orig_c, subs_c)}</td>
                            <td>${fmtInt(units_c)}</td>

                            <td >${renderCell(orig_r, effective_subs_r)}</td>
                            <td>${fmtInt(units_r)}</td>

                            <td>${renderCell(orig_l, subs_l)}</td>
                            <td>${fmtInt(units_l)}</td>

                            <td >${renderCell(raw_total_subs, remaining_subs)}</td>
                            <td>${renderCell(total_units, remaining_units)}</td>

                            <td></td>
                        </tr>
                        <tr class="chance-row">
                            <td colspan="3">סיכויי זכייה</td>
                            <td>${isHandicapped ? showPctOrDash(chance_h) : '-'}</td>
                            <td></td>
                            <td>${isCombat ? showPctOrDash(chance_c) : '-'}</td>
                            <td></td>
                            <td>${(isReserved || isCombat) ? showPctOrDash(chance_r) : '-'}</td>
                            <td></td>
                            <td>${isLocal(project) ? showPctOrDash(chance_l) : '-'}</td>
                            <td></td>
                            <td>${showPctOrDash(chance_g)}</td>
                            <td></td>
                            <td>${overall_chance_percent}</td>
                        </tr>
                    `;
                        });

                        const total_city_chance_val = overallChances.length > 0
                            ? (1 - overallChances.reduce((product, chance) => product * (1 - chance), 1))
                            : 0;
                        const total_city_chance_percent = (!isNaN(total_city_chance_val) && isFinite(total_city_chance_val))
                            ? (Math.max(0, Math.min(1, total_city_chance_val)) * 100).toFixed(2) + '%'
                            : '-';

                        tableHtml += `
                    <tr class="total-row">
                        <td colspan="13">סיכוי זכייה כולל בעיר</td>
                        <td>${total_city_chance_percent}</td>
                    </tr>
                    </tbody>
                </table>
                `;

                        perCityResults.push({
                            city: cityDescription,
                            html: tableHtml,
                            totalVal: (isNaN(total_city_chance_val) || !isFinite(total_city_chance_val)) ? 0 : Math.max(0, Math.min(1, total_city_chance_val)),
                            totalText: total_city_chance_percent
                        });
                    } else {
                        perCityResults.push({
                            city: cityDescription,
                            html: `<p role="alert">לא נמצאו פרויקטים עם תיאור העיר '${cityDescription}'.</p>`,
                            totalVal: 0,
                            totalText: '-'
                        });
                    }
                }

                // If no city was selected, show ONLY the 3 cities with the highest total chance
                // let resultsToShow;
                // if (!selectedCities || selectedCities.length === 0) {
                //     resultsToShow = [...perCityResults]
                //         .sort((a, b) => b.totalVal - a.totalVal)
                //         .slice(0, 3);
                // } else {
                //     resultsToShow = perCityResults;
                // }

                let allResultsHtml = [...perCityResults]
                    .sort((a, b) => b.totalVal - a.totalVal)
                    .map(r => r.html)
                    .join('');
                // let allResultsHtml = resultsToShow.map(r => r.html).join('');

                document.getElementById('results').innerHTML = allResultsHtml;

                const day = String(currentDate.getDate()).padStart(2, '0');
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const year = String(currentDate.getFullYear()).slice(-2);
                const dateString = `${day}.${month}.${year}`;
                const timeString = currentDate.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('results').innerHTML += `
            <p>מעודכן ל ${dateString} ${timeString} (רענון הדף ייבא נתונים מחדש)</p>
        `;

            } catch (error) {
                document.getElementById('results').innerHTML = `<p role="alert">אירעה שגיאה: ${error.message}</p>`;
            } finally {
                const nonTotalRows = document.querySelectorAll('tr:not(.total-row)');
                nonTotalRows.forEach(row => {
                    row.classList.add('toggleable', 'none');
                });

                loader.classList.remove('loader');
                loader.setAttribute('aria-busy', 'false');
            }
        }

        function toggleTableRows(caption) {
            const table = caption.closest('table');
            const toggleables = table.querySelectorAll('.toggleable');
            const isExpanded = caption.getAttribute('aria-expanded') === 'true';
            toggleables.forEach(element => {
                if (isExpanded) {
                    element.classList.add("none");
                } else {
                    element.classList.remove("none");
                }
            });
            caption.setAttribute('aria-expanded', !isExpanded);
        }
        function selectAllCities() {
            const cityInput = document.getElementById('cityInput');
            for (let i = 0; i < cityInput.options.length; i++) {
                cityInput.options[i].selected = true;
            }
        }
    </script>
    <datalist id="cityList">
        <option value="אכסאל">
        <option value="אשקלון">
        <option value="באר יעקב">
        <option value="באר שבע">
        <option value="בית שמש">
        <option value="דימונה">
        <option value="טבריה">
        <option value="יבנה">
        <option value="יהוד">
        <option value="ירושלים">
        <option value="כפר ורדים">
        <option value="מעלות-תרשיחא">
        <option value="מצפה רמון">
        <option value="נוף הגליל">
        <option value="נתניה">
        <option value="עכו">
        <option value="עפולה">
        <option value="קריית ביאליק">
        <option value="קריית גת">
        <option value="קריית עקרון">
        <option value="רעננה">
    </datalist>
</body>

</html>