<!DOCTYPE html>
<html dir="rtl" lang="he">

<head>
    <title>住  - 专 </title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'></text></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:image" content="https://bets.github.io/DiscountHouse/img/chance-display.jpg">
    <link rel="stylesheet" href="index.css">
    <meta charset="UTF-8">
</head>

<body>
    <div class="autoMargin">
        <span id="loader" class="" aria-live="polite" aria-busy="false"></span>
        <h1>拽转 住  - 专 </h1>
        <div class="note">砖  注砖 砖砖 注爪  专转 注 砖砖 转爪转</div>

        <div class="main-flex">

            <div class="form-container">
                <form aria-labelledby="form-title">
                    <fieldset>
                        <legend id="form-title" class="visually-hidden">专转 砖</legend>
                        <h3 id="status-title">专 转 注 砖</h3>
                        <div class="checkbox-container" role="group" aria-labelledby="status-title">
                            <label for="handicappedSubscriber"><input type="checkbox" id="handicappedSubscriber"
                                    value="HandicappedSubscriber"> 注 转</label>
                            <label for="combatReservistSubscriber"><input type="checkbox" id="combatReservistSubscriber"
                                    value="CombatReservistSubscriber">  拽专</label>
                            <label for="reservedDutySubscriber"><input type="checkbox" id="reservedDutySubscriber"
                                    value="ReservedDutySubscriber"> </label>
                            <label style="flex-basis: 100%;" for="localSubscriber">  注专
                                <input type="search" id="localSubscriber" list="cityList" value="" aria-label="专 注专"
                                    style="width:130px;margin-right: 10px;text-align: center;">
                                <!-- <input type="checkbox" id="localSubscriber" value="LocalSubscriber"> -->
                            </label>
                        </div>

                        <h3 id="percent-title">注专转</h3>
                        <div class="note"> 注  注 专砖 砖 砖转砖 注专 </div>
                        <div class="input-container-grid" role="group" aria-labelledby="percent-title">
                            <label for="combatPercent" title="转  专砖 专"> 砖专转  拽专:
                            </label>
                            <input type="number" id="combatPercent" min="0" max="100" step="1" value="10"
                                aria-label=" 砖专转  拽专">
                            <label for="reservedPercent" title="转  专砖 专"> 砖专转   拽专:
                            </label>
                            <input type="number" id="reservedPercent" min="0" max="100" step="1" value="10"
                                aria-label=" 砖专转 ">

                            <label for="recurringSubscribersPercent"> 专砖  驻专拽:
                            </label>
                            <input type="number" id="recurringSubscribersPercent" min="0" max="100" step="1" value="90"
                                aria-label=" 专砖  驻专拽">

                        </div>

                        <h3 id="city-title">驻砖 驻 注专</h3>
                        <div class="note">专  住专 ctrl + 拽拽</div>
                        <div class="input-container" role="group" aria-labelledby="city-title">
                            <!-- <label for="cityInput">专 注 3 注专: </label> -->
                            <select id="cityInput" multiple size="5" aria-label="专 注专">
                                <option value="住">住</option>
                                <option value="砖拽">砖拽</option>
                                <option value="专 注拽">专 注拽</option>
                                <option value="专 砖注">专 砖注</option>
                                <option value="转 砖砖">转 砖砖</option>
                                <option value=""></option>
                                <option value="专">专</option>
                                <option value=""></option>
                                <option value=""></option>
                                <option value="专砖">专砖</option>
                                <option value="驻专 专">驻专 专</option>
                                <option value="注转-转专砖">注转-转专砖</option>
                                <option value="爪驻 专">爪驻 专</option>
                                <option value="祝 ">祝 </option>
                                <option value="转">转</option>
                                <option value="注">注</option>
                                <option value="注驻">注驻</option>
                                <option value="拽专转 拽">拽专转 拽</option>
                                <option value="拽专转 转">拽专转 转</option>
                                <option value="拽专转 注拽专">拽专转 注拽专</option>
                                <option value="专注">专注</option>
                            </select>
                            <!-- <label for="cityInput">注专: </label>
                            <input type="search" id="cityInput" list="cityList" value="" aria-label="专 注专"> -->
                            <div class="flex-column">
                                <a href="javascript:void(0)" onclick="selectAllCities(true)">专 转  注专</a>
                                <a href="javascript:void(0)" onclick="selectAllCities(false)">驻住 专</a>
                                <button type="button" onclick="fetchAndDisplayProjects()"
                                    aria-label="砖 转爪转">砖</button>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
        <div id="results" class="table-wrapper" aria-live="polite"></div>

        <div class="bottom-image">
            <div style="margin: 0 auto;">住 驻专住转,  注  爪 驻</div>
            <!-- <img src="https://picsum.photos/400/100" alt=" 砖 驻专住转" /> -->
            <div id="frame"
                style="width: 100%;margin: auto;background: rgba(0, 0, 0, 0.50);position: relative; z-index: 99998;">
                <iframe data-aa='2408072' src='//acceptable.a-ads.com/2408072/?size=Adaptive'
                    style='border:0; padding:0; width:70%; height:auto; overflow:hidden;display: block;margin: auto'></iframe>
            </div>
        </div>
        <div>
            <h3>注专转</h3>
            <ul>
                <li>住 住驻专 注转, 砖 住 转  转  专 转 砖 驻专拽</li>
                <li> 专 砖 注  转 住专  砖</li>
                <li> 拽专  专 0   砖砖 专砖 驻 转 专转</li>
                <li>专 转 砖 驻专拽 住专 住驻专  专转 专转 驻 注</li>
                <li>' 专砖  驻专拽' 专 驻专拽 驻专拽,  砖 专 砖-90% 爪  专转, 
                     驻专拽 转 专 住驻专 专砖 90% 住驻专  驻专拽 拽, 住 
                    注</li>
                <li>砖专 砖 住驻专 转转 住驻专 住专, 住驻专 注  注 住住, 转转 砖 驻注 专 专转
                     拽</li>
                <li>砖转  爪注转  - <a href="mailto:bez.code.r+dira@gmail.com">bez.code.r+dira@gmail.com</a></li>
                <li>  驻专驻住专 住住拽 转 注转 :-)</li>
            </ul>
        </div>
        <!-- <div>
                <h3>爪专转 砖转</h3>
                <div>住转 砖 注  砖转   砖注 砖砖 砖 注 注  砖转砖  爪专 拽
                    注砖转 转</div>
            </div> -->

    </div>
    <script>
        // Restore user inputs from localstorage
        const selectedCities = JSON.parse(localStorage.getItem('selectedCities')) || [];
        const cityInput = document.getElementById('cityInput');
        for (const option of cityInput.options) {
            option.selected = selectedCities.includes(option.value);
        }
        document.getElementById('localSubscriber').value = localStorage.getItem('localCity') || '';
        document.getElementById('handicappedSubscriber').checked = localStorage.getItem('isHandicapped') === 'true';
        document.getElementById('reservedDutySubscriber').checked = localStorage.getItem('isReserved') === 'true';
        document.getElementById('combatReservistSubscriber').checked = localStorage.getItem('isCombat') === 'true';
        document.getElementById('combatPercent').value = parseInt(localStorage.getItem('combatPercent') * 100) || 10;
        document.getElementById('reservedPercent').value = parseInt(localStorage.getItem('reservedPercent') * 100) || 10;
        document.getElementById('recurringSubscribersPercent').value = parseInt(localStorage.getItem('recurringPercent') * 100) || 90;

        let data = {};
        let currentDate;

        async function fetchAndDisplayProjects() {
            const loader = document.getElementById('loader');
            loader.classList.add('loader');
            loader.setAttribute('aria-busy', 'true');

            const selectedCities = Array.from(document.getElementById('cityInput').selectedOptions).map(option => option.value);
            const localCity = document.getElementById('localSubscriber').value.trim();
            const isHandicapped = document.getElementById('handicappedSubscriber').checked;
            const isReserved = document.getElementById('reservedDutySubscriber').checked;
            const isCombat = document.getElementById('combatReservistSubscriber').checked;

            const combatPercent = parseFloat(document.getElementById('combatPercent').value) / 100 || 0;
            const reservedPercent = parseFloat(document.getElementById('reservedPercent').value) / 100 || 0;
            const recurringPercent = parseFloat(document.getElementById('recurringSubscribersPercent').value) / 100 || 0;

            // Save all user inputs to localstorage so we can use it again later
            localStorage.setItem('selectedCities', JSON.stringify(selectedCities));
            localStorage.setItem('localCity', localCity);
            localStorage.setItem('isHandicapped', isHandicapped);
            localStorage.setItem('isReserved', isReserved);
            localStorage.setItem('isCombat', isCombat);
            localStorage.setItem('combatPercent', combatPercent);
            localStorage.setItem('reservedPercent', reservedPercent);
            localStorage.setItem('recurringPercent', recurringPercent);

            // Helpers
            function fmtInt(n) {
                return (typeof n === 'number' && isFinite(n)) ? Math.round(n).toLocaleString('he-IL') : '-';
            }
            function renderCell(originalNum, calculatedNum) {
                const title = "砖 - 专 专转  拽";
                const origStr = fmtInt(originalNum);
                const calcStr = fmtInt(calculatedNum);
                if (calcStr === '-' || origStr === calcStr) return origStr;
                return `${origStr}<div title="${title}">(${calcStr})</div>`;
            }
            function showPctOrDash(v) {
                const result = (!isNaN(v) && isFinite(v)) ? (v * 100).toFixed(1).replace(/\.?0*$/, '') + '%' : '-';
                return result;
            }
            function isLocal(project) {
                return project && project.CityDescription === localCity;
            }

            try {
                if (Object.keys(data).length === 0) {
                    const queryString = "?firstApplicantIdentityNumber=&secondApplicantIdentityNumber=&ProjectStatus=4&Entitlement=1&PageNumber=1&PageSize=75&IsInit=true&";
                    const encodedString = encodeURIComponent(queryString);
                    const response = await fetch("https://www.dira.moch.gov.il/api/Invoker?method=Projects&param=" + encodedString, {
                        "headers": {
                            "User-Agent": "Mozilla/5.0",
                            "Accept": "application/json, text/plain, */*",
                            "Accept-Language": "he-IL,he;q=0.8,en-US;q=0.5,en;q=0.3",
                            "Sec-GPC": "1",
                            "Sec-Fetch-Dest": "empty",
                            "Sec-Fetch-Mode": "cors",
                            "Pragma": "no-cache",
                            "Cache-Control": "no-cache"
                        },
                        "referrer": "https://www.dira.moch.gov.il/ProjectsList",
                        "method": "GET",
                        "mode": "cors"
                    });

                    data = await response.json();
                    currentDate = new Date();
                } else {
                    // Small delay to visualize update
                    await new Promise(resolve => setTimeout(resolve, 700));
                }

                // Decide which cities to process:
                const allCityNames = Array.from(new Set((data.ProjectItems || []).map(p => p.CityDescription))).filter(Boolean);
                const citiesToProcess = (selectedCities && selectedCities.length > 0) ? selectedCities : allCityNames;

                // For each city, build its table and keep its total chance for later ranking
                const perCityResults = [];

                for (const cityDescription of citiesToProcess) {
                    let projects = (data.ProjectItems || []).filter(item => item.CityDescription === cityDescription);

                    projects.sort((a, b) => {
                        const na = Number(a.LotteryNumber);
                        const nb = Number(b.LotteryNumber);
                        if (!isNaN(na) && !isNaN(nb)) return na - nb;
                        return String(a.LotteryNumber || '').localeCompare(String(b.LotteryNumber || ''));
                    });

                    const overallChances = [];
                    let tableHtml = '';

                    if (projects.length > 0) {
                        const cumulativeWinners = {
                            handicapped: 0,
                            combat: 0,
                            reservist: 0,
                            local: 0,
                            general: 0,
                            total: 0
                        };

                        // infer handicapped/local % from the first project (safely)
                        const first = projects[0];
                        const firstTotalSubscribers = Number(first.TotalSubscribers) || 0;
                        const inferredHandicappedPercent = firstTotalSubscribers > 0 ? (Number(first.TotalHandicappedSubscribers) || 0) / firstTotalSubscribers : 0;
                        const inferredLocalPercent = firstTotalSubscribers > 0 ? (Number(first.TotalLocalSubscribers) || 0) / firstTotalSubscribers : 0;

                        tableHtml += `
                <table aria-describedby="results-caption" role="button" aria-expanded="false" aria-controls="lotteryTableContent">
                    <caption id="results-caption" onclick="toggleTableRows(this)">${cityDescription}</caption>
                    <thead>
                    <tr>
                        <th scope="col">专</th>
                        <th scope="col">注专</th>
                        <th scope="col">专 "专</th>
                        <th scope="col">专砖 注 转</th>
                        <th scope="col">专转 注 转</th>
                        <th scope="col">专砖  拽专</th>
                        <th scope="col">专转  拽专</th>
                        <th scope="col">专砖 </th>
                        <th scope="col">专转 </th>
                        <th scope="col">专砖  注专</th>
                        <th scope="col">专转  注专</th>
                        <th scope="col">住" 专砖</th>
                        <th scope="col">专转</th>
                        <th scope="col">住  </th>
                    </tr>
                    </thead>
                    <tbody>
                `;

                        projects.forEach((project) => {
                            // Units per category
                            const units_h = Number(project.HousingUnitsForHandicapped) || 0;
                            const units_c = Number(project.HU_CombatReservist_L) || 0;
                            const units_r = Number(project.HU_Reservists_L) || 0;
                            const units_l = Number(project.LocalHousing) || 0;
                            const total_units = Number(project.LotteryApparmentsNum) || 0;

                            // ----- TOTAL subscribers: original (raw) -----
                            const raw_total_subs = Number(project.TotalSubscribers) || 0;

                            // Adjusted total used upstream for category estimates (recurring winners only).
                            const totalSubscribers = Math.max(0, Math.floor(raw_total_subs - recurringPercent * cumulativeWinners.total));

                            // ----- Handicapped -----
                            const apiHand = Number(project.TotalHandicappedSubscribers);
                            const orig_h = (Number.isFinite(apiHand) && apiHand > 0)
                                ? Math.floor(apiHand)
                                : Math.floor(raw_total_subs * inferredHandicappedPercent);
                            let subs_h = Math.max(0, Math.floor(orig_h - recurringPercent * cumulativeWinners.handicapped));

                            // ----- Combat -----
                            const apiCombat = Number(project.TotalCombatReservistSubscribers);
                            const orig_c = (Number.isFinite(apiCombat) && apiCombat > 0)
                                ? Math.floor(apiCombat)
                                : Math.floor(combatPercent > 0 ? raw_total_subs * combatPercent : units_c);
                            const noInputMin_c = combatPercent == 0 && apiCombat == 0 ? units_c : 0;
                            let subs_c = Math.max(noInputMin_c, Math.floor(orig_c - recurringPercent * cumulativeWinners.combat));

                            // ----- Reservists -----
                            const apiReserved = Number(project.TotalReservedDutySubscribers);
                            const orig_r = (Number.isFinite(apiReserved) && apiReserved > 0)
                                ? Math.floor(apiReserved)
                                : Math.floor(reservedPercent > 0 ? raw_total_subs * reservedPercent : units_r);
                            const noInputMin_r = reservedPercent == 0 && apiReserved == 0 ? units_r : 0;
                            let subs_r = Math.max(noInputMin_r, Math.floor(orig_r - recurringPercent * cumulativeWinners.reservist));

                            // ----- Local -----
                            const apiLocal = Number(project.TotalLocalSubscribers);
                            const orig_l = (Number.isFinite(apiLocal) && apiLocal > 0)
                                ? Math.floor(apiLocal)
                                : Math.floor(raw_total_subs * inferredLocalPercent);
                            let subs_l = Math.max(0, Math.floor(orig_l - recurringPercent * cumulativeWinners.local));

                            // Price field
                            const price_per_unit = (project.PricePerUnit ?? '');

                            // Chances
                            const chance_h = isHandicapped && subs_h > 0 ? Math.min(1, units_h / subs_h) : 0;

                            // Winners per category and spillover (combat -> reservist)
                            const winners_h = Math.min(units_h, subs_h);

                            const winners_c = Math.min(units_c, subs_c);
                            const remaining_combat = Math.max(0, subs_c - winners_c);

                            const effective_subs_r = Math.max(0, subs_r + remaining_combat);
                            const chance_c = isCombat && subs_c > 0 ? Math.min(1, units_c / subs_c) : 0;
                            const chance_r = (isReserved || isCombat) && effective_subs_r > 0 ? Math.min(1, units_r / effective_subs_r) : 0;

                            const winners_r = Math.min(units_r, effective_subs_r);

                            const chance_l = isLocal(project) && subs_l > 0 ? Math.min(1, units_l / subs_l) : 0;
                            const winners_l = Math.min(units_l, subs_l);

                            // General lottery
                            let remaining_units = Math.max(0, total_units - (winners_h + winners_c + winners_r + winners_l));
                            let remaining_subs = Math.max(0, totalSubscribers - (winners_h + winners_c + winners_r + winners_l));
                            const chance_g = remaining_subs > 0 ? Math.min(1, remaining_units / remaining_subs) : 0;

                            // Overall chance (sequential)
                            let overall_chance = 0;
                            let prob_not_won = 1;
                            function safeAddChance(ch) {
                                if (!isNaN(ch) && isFinite(ch) && ch > 0) {
                                    overall_chance += prob_not_won * ch;
                                    prob_not_won *= (1 - ch);
                                }
                            }
                            safeAddChance(chance_h);
                            safeAddChance(chance_c);
                            safeAddChance(chance_r);
                            safeAddChance(chance_l);
                            safeAddChance(chance_g);

                            const overall_chance_percent = (!isNaN(overall_chance) && isFinite(overall_chance)) ? (overall_chance * 100).toFixed(1).replace(/\.?0*$/, '') + '%' : '-';
                            overallChances.push(!isNaN(overall_chance) && isFinite(overall_chance) ? Math.max(0, Math.min(1, overall_chance)) : 0);

                            // Update cumulative winners
                            const general_winners = Math.min(remaining_units, remaining_subs);
                            cumulativeWinners.handicapped += winners_h;
                            cumulativeWinners.combat += winners_c;
                            cumulativeWinners.reservist += winners_r;
                            cumulativeWinners.local += winners_l;
                            cumulativeWinners.general += general_winners;
                            cumulativeWinners.total =
                                cumulativeWinners.handicapped +
                                cumulativeWinners.combat +
                                cumulativeWinners.reservist +
                                cumulativeWinners.local +
                                cumulativeWinners.general;

                            // Rows
                            tableHtml += `
                        <tr class="project-row">
                            <td>${project.LotteryNumber || ''}</td>
                            <td>${project.CityDescription || ''}</td>
                            <td>${fmtInt(price_per_unit)}</td>

                            <td >${renderCell(orig_h, subs_h)}</td>
                            <td>${fmtInt(units_h)}</td>

                            <td >${renderCell(orig_c, subs_c)}</td>
                            <td>${fmtInt(units_c)}</td>

                            <td >${renderCell(orig_r, effective_subs_r)}</td>
                            <td>${fmtInt(units_r)}</td>

                            <td>${renderCell(orig_l, subs_l)}</td>
                            <td>${fmtInt(units_l)}</td>

                            <td >${renderCell(raw_total_subs, remaining_subs)}</td>
                            <td>${renderCell(total_units, remaining_units)}</td>

                            <td></td>
                        </tr>
                        <tr class="chance-row">
                            <td colspan="3">住 </td>
                            <td colspan="2">${isHandicapped ? showPctOrDash(chance_h) : '-'}</td>
                            <td colspan="2">${isCombat ? showPctOrDash(chance_c) : '-'}</td>
                            <td colspan="2">${(isReserved || isCombat) ? showPctOrDash(chance_r) : '-'}</td>
                            <td colspan="2">${isLocal(project) ? showPctOrDash(chance_l) : '-'}</td>
                            <td colspan="2">${showPctOrDash(chance_g)}</td>
                            <td>${overall_chance_percent}</td>
                        </tr>
                    `;
                        });

                        const total_city_chance_val = overallChances.length > 0
                            ? (1 - overallChances.reduce((product, chance) => product * (1 - chance), 1))
                            : 0;
                        const total_city_chance_percent = (!isNaN(total_city_chance_val) && isFinite(total_city_chance_val))
                            ? (Math.max(0, Math.min(1, total_city_chance_val)) * 100).toFixed(1).replace(/\.?0*$/, '') + '%'
                            : '-';

                        tableHtml += `
                    <tr class="total-row">
                        <td colspan="13">住   注专</td>
                        <td>${total_city_chance_percent}</td>
                    </tr>
                    </tbody>
                </table>
                `;

                        perCityResults.push({
                            city: cityDescription,
                            html: tableHtml,
                            totalVal: (isNaN(total_city_chance_val) || !isFinite(total_city_chance_val)) ? 0 : Math.max(0, Math.min(1, total_city_chance_val)),
                            totalText: total_city_chance_percent
                        });
                    } else {
                        perCityResults.push({
                            city: cityDescription,
                            html: `<p role="alert"> 爪 驻专拽 注 转专 注专 '${cityDescription}'.</p>`,
                            totalVal: 0,
                            totalText: '-'
                        });
                    }
                }

                let allResultsHtml = [...perCityResults]
                    .sort((a, b) => b.totalVal - a.totalVal)
                    .map(r => r.html)
                    .join('');
                document.getElementById('results').innerHTML = allResultsHtml;

                //if less then 4 selectedCities then calculate the chance to win any of them
                if (selectedCities.length < 4) {
                    const totalChance = 1 - perCityResults.reduce((product, result) => product * (1 - result.totalVal), 1);
                    const total_chance_percent = (!isNaN(totalChance) && isFinite(totalChance))
                        ? (Math.max(0, Math.min(1, totalChance)) * 100).toFixed(1).replace(/\.?0*$/, '') + '%'
                        : '-';

                    const cityNames = selectedCities.length > 0 ? selectedCities.join(', ') : ' 注专';

                    document.getElementById('results').innerHTML += `
        <div class="total-chance-summary">
            <div class="total-chance-content">
                <div class="total-chance-title">住  </div>
                <div class="total-chance-value">${total_chance_percent}</div>
                <div class="total-chance-subtitle">转 驻转  驻专拽</div>
                <div class="cities-count">${selectedCities.length} 注专 专</div>
            </div>
        </div>
    `;
                }


                const day = String(currentDate.getDate()).padStart(2, '0');
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const year = String(currentDate.getFullYear()).slice(-2);
                const dateString = `${day}.${month}.${year}`;
                const timeString = currentDate.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('results').innerHTML += `
            <p>注  ${dateString} ${timeString}
                <br/>(专注 祝  转 砖)</p>
        `;

            } catch (error) {
                document.getElementById('results').innerHTML = `<p role="alert">专注 砖: ${error.message}</p>`;
            } finally {
                const nonTotalRows = document.querySelectorAll('tr:not(.total-row)');
                nonTotalRows.forEach(row => {
                    row.classList.add('toggleable', 'none');
                });

                loader.classList.remove('loader');
                loader.setAttribute('aria-busy', 'false');
            }
        }

        function toggleTableRows(caption) {
            const table = caption.closest('table');
            const toggleables = table.querySelectorAll('.toggleable');
            const isExpanded = table.getAttribute('aria-expanded') === 'true';
            toggleables.forEach(element => {
                if (isExpanded) {
                    element.classList.add("none");
                } else {
                    element.classList.remove("none");
                }
            });
            table.setAttribute('aria-expanded', !isExpanded);
        }
        function selectAllCities(val) {
            const cityInput = document.getElementById('cityInput');
            for (let i = 0; i < cityInput.options.length; i++) {
                cityInput.options[i].selected = val;
            }
        }        
    </script>
    <datalist id="cityList">
        <option value="住">
        <option value="砖拽">
        <option value="专 注拽">
        <option value="专 砖注">
        <option value="转 砖砖">
        <option value="">
        <option value="专">
        <option value="">
        <option value="">
        <option value="专砖">
        <option value="驻专 专">
        <option value="注转-转专砖">
        <option value="爪驻 专">
        <option value="祝 ">
        <option value="转">
        <option value="注">
        <option value="注驻">
        <option value="拽专转 拽">
        <option value="拽专转 转">
        <option value="拽专转 注拽专">
        <option value="专注">
    </datalist>
</body>

</html>